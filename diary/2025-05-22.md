# 2025-05-22

## Cloud Run functions: Qwik Start - Console

## Google Cloud Run functions と AWS Lambda の比較

| 項目             | Google Cloud Run (Cloud Functions)                     | AWS Lambda                                            |
| ---------------- | ------------------------------------------------------ | ----------------------------------------------------- |
| サービス概要     | コンテナ/関数をサーバーレスで実行                      | 関数をサーバーレスで実行                              |
| 実行単位         | コンテナイメージまたは関数                             | 関数コード(zip, image)                                |
| トリガー         | HTTP, Pub/Sub, Cloud Storage等                         | HTTP(API Gateway), S3, SQS, EventBridge等             |
| 言語サポート     | 任意（コンテナなら何でも）/Node.js, Python, Go, Java等 | Node.js, Python, Go, Java, Ruby, .NET, Custom Runtime |
| 最大実行時間     | 60分（Cloud Run）/ 9分（Functions）                    | 15分                                                  |
| スケーリング     | リクエストごと自動スケール                             | リクエストごと自動スケール                            |
| VPC接続          | 可能                                                   | 可能                                                  |
| 永続ストレージ   | Cloud Storage等外部サービス                            | S3等外部サービス                                      |
| IAM連携          | 可能（細かい権限設定）                                 | 可能（細かい権限設定）                                |
| デプロイ方法     | gcloud CLI, Console, GitHub Actions等                  | AWS CLI, Console, SAM, CDK等                          |
| 料金体系         | 実行時間・リクエスト数・リソース                       | 実行時間・リクエスト数・リソース                      |
| コールドスタート | あり（ただし高速）                                     | あり                                                  |
| コンテナサポート | Cloud Runはフルサポート                                | Lambdaは一部サポート（Container Image）               |

## Cloud Run functions: Qwik Start - Command Line

### 環境の準備

```sh
REGION=<your-region>
PROJECT_ID=<your-project-id>
gcloud config set run/region $REGION
```

### 関数の準備

```sh
mkdir gcf_hello_world && cd $_
nano index.js
```

```js
const functions = require('@google-cloud/functions-framework');

functions.cloudEvent('helloPubSub', cloudEvent => {
  const base64name = cloudEvent.data.message.data;

  const name = base64name
    ? Buffer.from(base64name, 'base64').toString()
    : 'World';

  console.log(`Hello, ${name}!`);
});
```

```sh
nano package.json
```

```json
{
  "name": "gcf_hello_world",
  "version": "1.0.0",
  "main": "index.js",
  "scripts": {
    "start": "node index.js",
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "dependencies": {
    "@google-cloud/functions-framework": "^3.0.0"
  }
}
```

```sh
npm install
```

### 関数のデプロイ

```sh
gcloud functions deploy nodejs-pubsub-function \
  --gen2 \
  --runtime nodejs20 \
  --region $REGION \
  --source . \
  --entry-point helloPubSub \
  --trigger-topic cf-demo \
  --stage-bucket $PROJECT_ID-bucket \
  --service-account cloudfunctionsa@$PROJECT_ID.iam.gserviceaccount.com \
  --allow-unauthenticated

gcloud functions describe nodejs-pubsub-function \
  --region $REGION
```

### 関数のテスト

```sh
gcloud pubsub topics publish cf-demo --message="Cloud Function Gen2"

gcloud functions logs read nodejs-pubsub-function \
  --region $REGION
```
