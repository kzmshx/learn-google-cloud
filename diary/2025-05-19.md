# 2025-05-19

## コマンド整理

### auth

```sh
gcloud auth list
```

### compute

- firewall-rules create
  - name
  - --direction
  - --priority
  - --network
  - --action
  - --rules
  - --source-ranges
  - --target-tags
  - --allow
- instances create
  - name
  - --zone
  - --tags
  - --machine-type
  - --image-family
  - --image-project
  - --metadata=startup-script=${script}

```sh
gcloud compute addresses create $name --region=$region

gcloud compute firewall-rules create $name \
  --direction=$direction \
  --priority=$priority \
  --network=$network \
  --action=$action \
  --rules=$rule \
  --source-ranges=$ip_range \
  --target-tags=$tag
gcloud compute firewall-rules list
gcloud compute firewall-rules list --filter="network='<network>'"
gcloud compute firewall-rules list --filter="NETWORK:'<network>' AND ALLOW:'<protocol>'"

gcloud compute http-health-checks create $name
gcloud compute http-health-checks create basic-check

gcloud compute instances create $name \
  --machine-type $machine_type \
  --zone $zone
gcloud compute instances list --filter=$filter
gcloud compute instances list --filter="name=('<name>')"
gcloud compute instances list --filter="name=('<name>')" --format="value(EXTERNAL_IP)"

gcloud compute project-info describe --project $project

gcloud compute ssh $name --zone $zone
```

### config

```sh
gcloud config get $target

gcloud config list

gcloud config set compute/region $region
gcloud config set compute/zone $zone
```

### logging

```sh
gcloud logging logs list --filter=$filter

gcloud logging read "resource.type=gce_instance" --limit $limit
gcloud logging read "resource.type=gce_instance AND labels.instance_name='$instance_name'" --limit $limit
```

## L4 ロードバランサー（ネットワークロードバランサー）を作る

1. リージョン、ゾーンを設定 (gcloud config set)
2. 静的外部IPを作成 (gcloud compute addresses create)
3. レガシーHTTPヘルスチェックリソースを作成 (gcloud compute http-health-checks create)
4. ターゲットプールを作成 (gcloud compute target-pools create)
5. ターゲットプールにインスタンスを追加 (gcloud compute target-pools add-instances)
6. ターゲットプールのフォワーディングルールを作成 (gcloud compute forwarding-rules create)

## L7 ロードバランサー（HTTP ロードバランサー）を作る

1. インスタンステンプレートを作成 (gcloud compute instance-templates create)
2. マネージドインスタンスグループを作成 (gcloud compute instance-groups managed create)
3. ファイアウォールルールを作成 (gcloud compute firewall-rules create)
4. グローバル静的外部IPアドレスを作成 (gcloud compute addresses create)
5. ロードバランサーのヘルスチェックを作成 (gcloud compute http-health-checks create)
6. バックエンドサービスを作成 (gcloud compute backend-services create)
7. バックエンドサービスのバックエンドにマネージドインスタンスグループを設定 (gcloud compute backend-services add-backend)
8. リクエストをバックエンドサービスにルーティングするURLマップを作成 (gcloud compute url-maps create)
9. URLマップにリクエストをルーティングするターゲットHTTPプロキシを作成 (gcloud compute target-http-proxies create)
10. リクエストをプロキシにルーティングするグローバル転送ルールを作成 (gcloud compute forwarding-rules create)

## Google Cloud vs AWS

### L4 ロードバランサー

| 項目           | GCP Network Load Balancer<br>(ターゲットプール/フォワーディングルール) | AWS NLB |
|----------------|----------------------------------------------------------|-------------------------------|
| 提供単位       | リージョン                                               | リージョン                    |
| 静的IP         | あり                                                     | あり（Elastic IP）            |
| パフォーマンス | 高スループット・低レイテンシ                             | 超高スループット・超低レイテンシ|
| TLS終端        | 一部サポート（Proxy LB等）                               | サポート（NLBでTLSリスナー）   |
| グローバル分散 | 非対応                                                   | 非対応                        |
| 主なメリット   | シンプルな構成、Googleバックボーン活用、高可用性、ヘルスチェック | 超高スケーラビリティ、TLS終端、PrivateLink連携、複数AZ対応 |

### L7 ロードバランサー

| 項目           | GCP Application Load Balancer<br>(バックエンドサービス/URLマップ/プロキシ) | AWS ALB |
|----------------|----------------------------------------------------------|-------------------------------|
| 提供単位       | グローバル                                               | リージョン                    |
| 静的IP         | あり（グローバルIP）                                      | あり（リージョン単位）         |
| パフォーマンス | 高スループット・低レイテンシ                             | 高スループット・低レイテンシ   |
| TLS終端        | サポート                                                 | サポート                      |
| グローバル分散 | 標準でグローバル                                          | Route53/CloudFront連携で実現   |
| 主なメリット   | 単一グローバルIP、シンプルな運用、グローバル冗長性        | 柔軟なルーティング、WAF/CloudFront連携、細かなトラフィック制御 |

## Compute Engine でのロードバランシングの実装: チャレンジラボ

### プロジェクトの jumphost インスタンスを作成する

```sh
REGION=us-east1
ZONE=us-east1-c
INSTANCE_NAME=nucleus-jumphost-405

gcloud config set compute/region $REGION
gcloud config set compute/zone $ZONE

gcloud compute instances create $INSTANCE_NAME \
  --machine-type e2-micro
```

### HTTP ロードバランサを設定する

- Google Cloud の HTTPS ロードバランサーはグローバルリソースなのでその構成要素はグローバルリソースとして作成する
  - バックエンドサービス
  - URLマップ
  - ターゲットプロキシ
  - フォワーディングルール
- Google Cloud のヘルスチェックIPレンジを許可する
  - [プローブIP範囲とファイアウォールルール | ヘルスチェックの概要 | Load Balancing | Google Cloud](https://cloud.google.com/load-balancing/docs/health-check-concepts?hl=ja#ip-ranges)
  - グローバル外部アプリケーションロードバランサ
    - 35.191.0.0/16
    - 130.211.0.0/22

```sh
REGION=us-east1
ZONE=us-east1-d
FW_NAME=accept-tcp-rule-759
echo $REGION, $ZONE, $FW_NAME

gcloud auth list
gcloud config list
gcloud config set compute/region $REGION
gcloud config get compute/region
gcloud config set compute/zone $ZONE
gcloud config get compute/zone

cat << EOF > startup.sh
#! /bin/bash
apt-get update
apt-get install -y nginx
service nginx start
sed -i -- 's/nginx/Google Cloud Platform - '"\$HOSTNAME"'/' /var/www/html/index.nginx-debian.html
EOF

gcloud compute instance-templates create lb-backend-template \
  --machine-type e2-medium \
  --metadata startup-script=startup.sh \
  --tags allow-health-check

gcloud compute instance-groups managed create lb-backend-group \
  --template lb-backend-template \
  --size 2

gcloud compute firewall-rules create $FW_NAME \
  --direction ingress \
  --allow tcp:80 \
  --source-ranges 35.191.0.0/16,130.211.0.0/22 \
  --target-tags allow-health-check

gcloud compute health-checks create http http-basic-check \
 --port 80

gcloud compute backend-services create lb-backend-service \
  --protocol HTTP \
  --port-name http \
  --health-checks http-basic-check \
  --global

gcloud compute backend-services add-backend lb-backend-service \
  --instance-group lb-backend-group \
  --instance-group-zone $ZONE \
  --global

gcloud compute url-maps create lb-url-map \
  --default-service lb-backend-service

gcloud compute target-http-proxies create lb-proxy \
  --url-map lb-url-map

gcloud compute forwarding-rules create http-content-forwarding-rule \
  --target-http-proxy lb-proxy \
  --ports 80 \
  --global
```

#### 問題発生

```sh
gcloud compute instance-templates create lb-backend-template \
  --machine-type e2-medium \
  --metadata startup-script=startup.sh \
  --tags allow-health-check
```

`--metadata startup-script=startup.sh` では、ファイル内容ではなく「ファイル名」がスクリプトとして渡されている
→ `--metadata-from-file` を使う

#### 修正対応

```sh
# インスタンステンプレートの新規作成
gcloud compute instance-templates create lb-backend-template-v2 \
  --machine-type e2-medium \
  --metadata-from-file startup-script=startup.sh \
  --tags allow-health-check

# マネージドインスタンスグループ（MIG）のローリングリプレース
gcloud compute instance-groups managed rolling-action start-update lb-backend-group \
  --version=template=lb-backend-template-v2

# ヘルスチェックの確認
gcloud compute instance-groups managed list-instances lb-backend-group
```

こういうミスして修正するとき、Terraform なら plan/apply のやり直しで済むんだよなぁ。

```sh
gcloud compute addresses create lb-ipv4-1 \
  --ip-version=IPV4 \
  --global

gcloud compute forwarding-rules delete http-content-forwarding-rule \
  --global

gcloud compute forwarding-rules create http-content-forwarding-rule \
  --address=lb-ipv4-1 \
  --target-http-proxy=lb-proxy \
  --ports=80 \
  --global
```

#### 修正完全版

```sh
REGION=us-east1
ZONE=us-east1-c
FW_NAME=permit-tcp-rule-482

gcloud config set compute/region $REGION
gcloud config set compute/zone $ZONE

cat << EOF > startup.sh
#! /bin/bash
apt-get update
apt-get install -y nginx
service nginx start
sed -i -- 's/nginx/Google Cloud Platform - '"\$HOSTNAME"'/' /var/www/html/index.nginx-debian.html
EOF

gcloud compute instance-templates create lb-backend-template \
  --machine-type e2-medium \
  --metadata-from-file startup-script=startup.sh \
  --tags allow-health-check

gcloud compute instance-groups managed create lb-backend-group \
  --template lb-backend-template \
  --size 2

gcloud compute firewall-rules create $FW_NAME \
  --direction ingress \
  --allow tcp:80 \
  --source-ranges 35.191.0.0/16,130.211.0.0/22 \
  --target-tags allow-health-check

gcloud compute health-checks create http http-basic-check \
 --port 80

gcloud compute backend-services create lb-backend-service \
  --protocol HTTP \
  --port-name http \
  --health-checks http-basic-check \
  --global

gcloud compute backend-services add-backend lb-backend-service \
  --instance-group lb-backend-group \
  --instance-group-zone $ZONE \
  --global

gcloud compute url-maps create lb-url-map \
  --default-service lb-backend-service

gcloud compute target-http-proxies create lb-proxy \
  --url-map lb-url-map

gcloud compute addresses create lb-ipv4-1 \
  --ip-version=IPV4 \
  --global

gcloud compute forwarding-rules create http-content-forwarding-rule \
  --address=lb-ipv4-1 \
  --target-http-proxy=lb-proxy \
  --ports=80 \
  --global
```

```sh
gcloud compute firewall-rules delete $FW_NAME

gcloud compute firewall-rules create $FW_NAME \
  --direction ingress \
  --allow tcp:80 \
  --target-tags allow-health-check
```

正しく環境を作成している、マネージドインスタンスグループは確かに作成した、ウェブサイトも確認できている、にもかかわらず Skills Boost が結果を認めない、詰んだ。
