# 2025-05-19

## コマンド整理

### auth

```sh
gcloud auth list
```

### compute

- firewall-rules create
  - name
  - --direction
  - --priority
  - --network
  - --action
  - --rules
  - --source-ranges
  - --target-tags
  - --allow
- instances create
  - name
  - --zone
  - --tags
  - --machine-type
  - --image-family
  - --image-project
  - --metadata=startup-script=${script}

```sh
gcloud compute addresses create $name --region=$region

gcloud compute firewall-rules create $name \
  --direction=$direction \
  --priority=$priority \
  --network=$network \
  --action=$action \
  --rules=$rule \
  --source-ranges=$ip_range \
  --target-tags=$tag
gcloud compute firewall-rules list
gcloud compute firewall-rules list --filter="network='<network>'"
gcloud compute firewall-rules list --filter="NETWORK:'<network>' AND ALLOW:'<protocol>'"

gcloud compute http-health-checks create $name
gcloud compute http-health-checks create basic-check

gcloud compute instances create $name \
  --machine-type $machine_type \
  --zone $zone
gcloud compute instances list --filter=$filter
gcloud compute instances list --filter="name=('<name>')"
gcloud compute instances list --filter="name=('<name>')" --format="value(EXTERNAL_IP)"

gcloud compute project-info describe --project $project

gcloud compute ssh $name --zone $zone
```

### config

```sh
gcloud config get $target

gcloud config list

gcloud config set compute/region $region
gcloud config set compute/zone $zone
```

### logging

```sh
gcloud logging logs list --filter=$filter

gcloud logging read "resource.type=gce_instance" --limit $limit
gcloud logging read "resource.type=gce_instance AND labels.instance_name='$instance_name'" --limit $limit
```

## L4 ロードバランサー（ネットワークロードバランサー）を作る

1. リージョン、ゾーンを設定 (gcloud config set)
2. 静的外部IPを作成 (gcloud compute addresses create)
3. レガシーHTTPヘルスチェックリソースを作成 (gcloud compute http-health-checks create)
4. ターゲットプールを作成 (gcloud compute target-pools create)
5. ターゲットプールにインスタンスを追加 (gcloud compute target-pools add-instances)
6. ターゲットプールのフォワーディングルールを作成 (gcloud compute forwarding-rules create)

## L7 ロードバランサー（HTTP ロードバランサー）を作る

1. インスタンステンプレートを作成 (gcloud compute instance-templates create)
2. マネージドインスタンスグループを作成 (gcloud compute instance-groups managed create)
3. ファイアウォールルールを作成 (gcloud compute firewall-rules create)
4. グローバル静的外部IPアドレスを作成 (gcloud compute addresses create)
5. ロードバランサーのヘルスチェックを作成 (gcloud compute http-health-checks create)
6. バックエンドサービスを作成 (gcloud compute backend-services create)
7. バックエンドサービスのバックエンドにマネージドインスタンスグループを設定 (gcloud compute backend-services add-backend)
8. リクエストをバックエンドサービスにルーティングするURLマップを作成 (gcloud compute url-maps create)
9. URLマップにリクエストをルーティングするターゲットHTTPプロキシを作成 (gcloud compute target-http-proxies create)
10. リクエストをプロキシにルーティングするグローバル転送ルールを作成 (gcloud compute forwarding-rules create)

## Google Cloud vs AWS

### L4 ロードバランサー

| 項目           | GCP Network Load Balancer<br>(ターゲットプール/フォワーディングルール) | AWS NLB |
|----------------|----------------------------------------------------------|-------------------------------|
| 提供単位       | リージョン                                               | リージョン                    |
| 静的IP         | あり                                                     | あり（Elastic IP）            |
| パフォーマンス | 高スループット・低レイテンシ                             | 超高スループット・超低レイテンシ|
| TLS終端        | 一部サポート（Proxy LB等）                               | サポート（NLBでTLSリスナー）   |
| グローバル分散 | 非対応                                                   | 非対応                        |
| 主なメリット   | シンプルな構成、Googleバックボーン活用、高可用性、ヘルスチェック | 超高スケーラビリティ、TLS終端、PrivateLink連携、複数AZ対応 |

### L7 ロードバランサー

| 項目           | GCP Application Load Balancer<br>(バックエンドサービス/URLマップ/プロキシ) | AWS ALB |
|----------------|----------------------------------------------------------|-------------------------------|
| 提供単位       | グローバル                                               | リージョン                    |
| 静的IP         | あり（グローバルIP）                                      | あり（リージョン単位）         |
| パフォーマンス | 高スループット・低レイテンシ                             | 高スループット・低レイテンシ   |
| TLS終端        | サポート                                                 | サポート                      |
| グローバル分散 | 標準でグローバル                                          | Route53/CloudFront連携で実現   |
| 主なメリット   | 単一グローバルIP、シンプルな運用、グローバル冗長性        | 柔軟なルーティング、WAF/CloudFront連携、細かなトラフィック制御 |
